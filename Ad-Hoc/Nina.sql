select top 100 * from uat_ca.mc_adhoc_nr_subs--НР все абоныwhere subs_id = 200031859927-- uat_ca.mc_adhoc_nr_offers sms----------------------------------------------------------------drop table nina_subs--drop table nina_subs_sms--drop table fin_subs_nina--drop table uat_ca.vf_ninarich_sms_flag_nov_20230711_2-----------------------------------------------------------------select * from nina_subs where up_price like '%0,%'----------------------------------------------------------------create multiset volatile table nina_subs as(select subs_id, left(up_price, index(up_price, ' ')) as  up_price from (select subs_id, text_1,-- LTRIM(text_1, 'С 30.12.22 стоимость вашего тарифа увеличится ') as upp_l substr(text_1, 50, 10) as up_price-- left(text_1, 60) as  up_pricefrom uat_ca.mc_adhoc_nr_subs t1 ) t1) with data primary index (subs_id)on commit preserve rows;--абоненты под нину риччи/*create multiset volatile table nina_subs as(SELECT subs_id, CAST(REGEXP_REPLACE(SUBSTRING(text_1 FROM POSITION('увеличится на ' in text_1) + LENGTH('увеличится на ') FOR POSITION('руб' in text_1) - POSITION('увеличится на ' in text_1) - LENGTH('увеличится на ')), '[^0-9]', '') AS INTEGER) AS up_priceFROM uat_ca.mc_adhoc_nr_subs)with data primary index (subs_id)on commit preserve rows; */---  select up_price, count(*) from  nina_subs  group by 1 ---------------------------------------------------------------------абоненты под нину риччи + смс флагcreate multiset volatile table nina_subs_sms as(select t1.subs_id     , t1.up_price     , t2.subs_id as sms_ind  from nina_subs t1  left join  uat_ca.mc_adhoc_nr_offers t2 on  t1.subs_id = t2.subs_id) with data primary index (subs_id)     on commit preserve rows;---select * from   nina_subs_sms   ---select count(subs_id) from nina_subs_sms      8812988/24458608------------------------------------------------------------------абоненты прошедшие опрос и попавшие под нинуcreate multiset volatile table fin_subs_nina, no log as(select t1.create_date     , t1.subs_id     , t1.region     , t1.branch_id     , t1.Lifetime     , t1.point_name     , t1.mark_6     , t1.nps     , t1.ltr     , t2.subs_id as subs_flg_nina     , t2.up_price     , t2.sms_ind  from uat_ca.v3_nps_bu t1  left join nina_subs_sms t2 on t1.subs_id = t2.subs_id  where 1=1    --and point_name in ('Контакт-центр', 'Тарифы', 'Мобильный интернет')    and create_date>= '2022-11-01') with dataprimary index (subs_id)on commit preserve rows;---select count(subs_id) from fin_subs_nina    ----------------------------------------------------------------select * from uat_ca.vf_ninarich_sms_flag_nov_20230711_2--create multiset table  uat_ca.vf_ninarich_sms_flag_nov_20230711_2 as(select *from fin_subs_nina  )with dataprimary index (subs_id)In:select top 100 * from uat_ca.mc_adhoc_nr_subs;      --источник tele2_uat.en_nina_ricciselect top 100 * from uat_ca.mc_adhoc_nr_offers;    --источник tele2_uat.mk_adhoc_nr_offersselect count(*) from uat_ca.mc_adhoc_nr_subs;       --24 458 608select count(*) from uat_ca.mc_adhoc_nr_offers;     --9 073 572select top 100 * from uat_ca.vf_ninarich_sms_flag_nov_20230711_2;       --основные точки контактаselect top 100 * from uat_ca.vf_ninarich_sms_flag_ntd_20230711_2;       --наш TDselect top 100 * from uat_ca.vf_ninarich_sms_flag_rtd_20230711_2;       --nps tdselect trunc(report_date,'mm'), count(*) from uat_ca.vf_ninarich_sms_flag_rtd_20230711_2 group by 1 order by 1;select count(*) from uat_ca.vf_ninarich_sms_flag_rtd_20230711_2select top 100 * from uat_ca.mc_base_td;select trunc(report_month,'mm'), count(*) from uat_ca.mc_base_td where subs_flg = 1 group by 1 order by 1;С 30.12.22 стоимость вашего тарифа увеличится на 25 руб./мес. Изменения вступят в силу в день списания абонентской платы. Подробнее об изменениях: 642. Добавьте к своему тарифу музыку и кино от VK Combo c подпиской Mixx S. Специально для вас она предоставляется бесплатно в течение 2 мес., далее - за 200 руб./мес.select substr('С 30.12.22 стоимость вашего тарифа увеличится на 25 руб./мес. Изменения вступят в силу в день списания абонентской платы. Подробнее об изменениях: 642. Добавьте к своему тарифу музыку и кино от VK Combo c подпиской Mixx S. Специально для вас она предоставляется бесплатно в течение 2 мес., далее - за 200 руб./мес.', 50, 10) as up_price;select left('25 руб./ме', index('25 руб./ме', ' ')) as  up_price;------------------------------------------------------------------Наш ТД------------------------------------------------------------------абоненты прошедшие опрос и попавшие под нину--drop table fin_subs_nina_ntd--drop table subs_our_td--drop table uat_ca.vf_ninarich_sms_flag_ntd_20230711_2------------------------------------------------наш топ d------------------------------------------------аобоненты которые подходят подо условия наш тдcreate multiset volatile table subs_our_td, no log as(select create_date, subs_id, region, branch_id, lt_gr, point_name, ans_2, nps_key, npsfrom uat_ca.v3_nps_main_tdwhere 1=1and create_date>= '2022-11-01') with data primary index(subs_id)on commit preserve rows-----------------------------------------------------абоненты прошедшие опрос и попавшие под нинуcreate multiset volatile table fin_subs_nina_ntd, no log as(select t1.*     , t2.subs_id as subs_flg_nina     , t2.up_price     , t2.sms_ind  from subs_our_td t1  left join nina_subs_sms t2 on t1.subs_id = t2.subs_id  where 1=1       and create_date>= '2022-11-01') with dataprimary index (subs_id)on commit preserve rows;--------------------------------------------------------select * from  uat_ca.vf_ninarich_sms_flag_ntd_20230711_2--------------------------------------------------------------create multiset table  uat_ca.vf_ninarich_sms_flag_ntd_20230711_2 as(select *from fin_subs_nina_ntd )with dataprimary index (subs_id)----------------------------------------------------------------Рыночный ТД select * from uat_ca.mc_base_td------------------------------------------------------------------абоненты прошедшие опрос и попавшие под нину--drop table subs_r_td--drop table fin_subs_nina_rtd--drop table uat_ca.vf_ninarich_sms_flag_rtd_20230711_2----------------------------------------------------------------------------------------------аобоненты которые подходят подо условия наш тдcreate multiset volatile table subs_r_td, no log as(select report_date, subs_id, region, branch_id, lt_gr, point_name, concept, nps_key, nps_flgfrom uat_ca.mc_base_tdwhere 1=1and report_date>= '2022-11-01') with data primary index(subs_id)on commit preserve rows--------------------------------------------------------------------------------------------------------абоненты прошедшие опрос и попавшие под нинуcreate multiset volatile table fin_subs_nina_rtd, no log as(select t1.*     , t2.subs_id as subs_flg_nina     , t2.up_price     , t2.sms_ind  from subs_r_td t1  left join nina_subs_sms t2 on t1.subs_id = t2.subs_id  where 1=1       and report_date>= '2022-11-01') with dataprimary index (subs_id)on commit preserve rows;----------------------------------------------------------------------------------------------------------------select * from  uat_ca.vf_ninarich_sms_flag_rtd_20230711_2--------------------------------------------------------------create multiset table  uat_ca.vf_ninarich_sms_flag_rtd_20230711_2 as(select *from fin_subs_nina_rtd where subs_id is not null)with dataprimary index (subs_id)------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------drop table nina_subs--абоненты под нину риччиcreate multiset volatile table nina_subs as(select subs_id, left(up_price, index(up_price, ' ')) as  up_price from(select subs_id     , text_1     --, LTRIM(text_1, 'С 30.12.22 стоимость вашего тарифа увеличится ') as upp_l     , SUBSTR(text_1, 50, 10) as up_price     --, left(text_1, 60) as  up_price  from uat_ca.mc_adhoc_nr_subs t1 ) t1) with data primary index (subs_id)     on commit preserve rows;     ---  select up_price, count(*) from  nina_subs  group by 1 ----------------------------------------------------------------------------------    --drop table nina_subs_sms--абоненты под нину риччи + смс флагcreate multiset volatile table nina_subs_sms as(select t1.subs_id     , t1.up_price     , t2.subs_id as sms_ind  from nina_subs t1  left join  uat_ca.mc_adhoc_nr_offers t2 on  t1.subs_id = t2.subs_id) with data primary index (subs_id)     on commit preserve rows;---select * from   nina_subs_sms   ---select count(sms_ind) from   nina_subs_sms --------------------------------------------------------------------------drop table fin_subs_nina--абоненты прошедшие опрос и попавшие под нинуcreate multiset volatile table fin_subs_nina, no log as(select t1.create_date     , t1.subs_id     , t1.region     , t1.branch_id     , t1.lt_day     , t1.point_name       , t1.mark_6     , t1.nps     , t1.ltr     , t2.subs_id as subs_flg_nina     , t2.up_price     , t2.sms_ind  from uat_ca.v3_nps_bu t1  inner join nina_subs_sms t2 on t1.subs_id = t2.subs_id  where 1=1    --and point_name in ('Контакт-центр', 'Тарифы', 'Мобильный интернет')    and create_date>= '2022-11-01') with dataprimary index (subs_id)on commit preserve rows;--select * from   fin_subs_nina ----------------------------------------------------------------------------sel top 100 * from uat_ca.v3_nps_bu------------------------------------------------------------------------------подходят под условия--drop table subscreate multiset volatile table subs, no log as(select t1.create_date     , t1.subs_id     , t1.region     , t1.branch_id     , t1.lifetime     , t1.point_name       , t1.class_mark_6     , t1.nps     , t1.ltr  from uat_ca.v3_nps_bu t1  where 1=1    --and point_name in ('Контакт-центр', 'Тарифы', 'Мобильный интернет')    and create_date>= '2022-11-01') with data primary index(subs_id)on commit preserve rows--select * from   subs---------------------------------------------------------------------------upd 11072023select * from uat_ca.vf_ninarich_sms_flag_nov_20230711create multiset table  uat_ca.vf_ninarich_sms_flag_nov_20230711 as(select t1.*, t2.subs_flg_nina     , t2.up_price     , t2.sms_indfrom subs t1 left join fin_subs_nina t2 on t1.subs_id = t2.subs_id  )with dataprimary index (subs_id)--upd 1107202--------------------------------------------------------------финал, прошли опрос и все флаги - нина и смс--drop table uat_ca.vf_ninarich_sms_flag_novcreate multiset table  uat_ca.vf_ninarich_sms_flag_nov_2 as(select t1.*, t2.subs_flg_nina     , t2.up_price     , t2.sms_indfrom subs t1 left join fin_subs_nina t2 on t1.subs_id = t2.subs_id  )with dataprimary index (subs_id)---------------------------------------------select * from uat_ca.vf_ninarich_sms_flag_nov_2----------------------------------------------------------------------------------------------------------------------------------------------------------------------наш топ d------------------------------------------------аобоненты которые подходят подо условия наш тд--upd 11072023create multiset volatile table subs_our_td, no log as(select create_date, subs_id, region, branch_id, lt_gr, point_name, ans_2, nps_key, npsfrom uat_ca.v3_nps_main_tdwhere 1=1and create_date>= '2022-11-01') with data primary index(subs_id)on commit preserve rows--абоненты прошедшие опрос и попавшие под нинуcreate multiset volatile table fin_subs_nina_ntd, no log as(select t1.*          , t2.subs_id as subs_flg_nina     , t2.up_price     , t2.sms_ind  from subs_our_td t1  inner join nina_subs_sms t2 on t1.subs_id = t2.subs_id  where 1=1       and create_date>= '2022-11-01') with dataprimary index (subs_id)on commit preserve rows;--------------------------------------------------------select * from  uat_ca.vf_ninarich_sms_flag_ntd_20230711--------------------------------------------------------------create multiset table  uat_ca.vf_ninarich_sms_flag_ntd_20230711 as(select t1.*, t2.subs_flg_nina     , t2.up_price     , t2.sms_indfrom subs_our_td t1 left join fin_subs_nina_ntd t2 on t1.subs_id = t2.subs_id  )with dataprimary index (subs_id)------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------наш топ d------------------------------------------------аобоненты которые подходят подо условия наш тдcreate multiset volatile table subs_our_td, no log as(select t1.create_date     , t1.subs_id     , t1.region               , t1.point_name       , t1.ans_2     , t1.nps as ltr     , t1.nps_key as nps  from uat_ca.v_poll_5 t1  where 1=1    --and point_name in ('Контакт-центр', 'Тарифы', 'Мобильный интернет')    and create_date>= '2022-11-01') with data primary index(subs_id)on commit preserve rows--select * from subs_our_td--------------------------------------------------абоненты прошедшие опрос и попавшие под нинуcreate multiset volatile table fin_subs_nina_ntd, no log as(select t1.create_date     , t1.subs_id     , t1.region          , t1.point_name       , t1.ans_2     , t1.nps as ltr     , t1.nps_key as nps          , t2.subs_id as subs_flg_nina     , t2.up_price     , t2.sms_ind  from uat_ca.v_poll_5 t1  inner join nina_subs_sms t2 on t1.subs_id = t2.subs_id  where 1=1       and create_date>= '2022-11-01') with dataprimary index (subs_id)on commit preserve rows;----------------------------------------------------------------------------------------------------------------------create multiset table  uat_ca.vf_ninarich_sms_flag_ntd as(select t1.*, t2.subs_flg_nina     , t2.up_price     , t2.sms_indfrom subs_our_td t1 left join fin_subs_nina_ntd t2 on t1.subs_id = t2.subs_id  )with dataprimary index (subs_id)